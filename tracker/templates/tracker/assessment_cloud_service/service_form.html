{% extends "tracker/base.html" %}
{# Removed {% load crispy_forms_tags %} #}

{% block title %}{{ page_title|default:"Assessment Cloud Service" }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>{{ page_title }}</h2>
    <p>Assessment: <a href="{% url 'tracker:client_assessment_cloud_service_list' assessment.pk %}">{{ assessment }}</a></p>

    {# Display existing service info if editing #}
    {% if object %}
        <h4 class="mb-3">Service: {{ object.cloud_service_definition.name }} {% if object.cloud_service_definition.vendor %}({{ object.cloud_service_definition.vendor }}){% endif %}</h4>
        {% if object.cloud_service_definition.service_url %}
            <p><a href="{{ object.cloud_service_definition.service_url }}" target="_blank" class="btn btn-sm btn-outline-info mb-3">Service Info/Login <i class="fa-solid fa-arrow-up-right-from-square fa-xs"></i></a></p>
        {% endif %}
    {% endif %}

    <form method="post" enctype="multipart/form-data" novalidate>
        {% csrf_token %}

        {# --- Non-Field Errors --- #}
        {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {% for error in form.non_field_errors %}
                    {{ error }}<br>
                {% endfor %}
            </div>
        {% endif %}

        {# --- Service Selection (Only on Create) --- #}
        {% if not object %}
            {# Assume form passed on create includes cloud_service_definition #}
            {% if form.cloud_service_definition %}
                 <div class="mb-3">
                    <label for="{{ form.cloud_service_definition.id_for_label }}" class="form-label">{{ form.cloud_service_definition.label }}{% if form.cloud_service_definition.field.required %}*{% endif %}</label>
                    {# Add form-select class via widget attrs in forms.py or manually if needed #}
                    {{ form.cloud_service_definition }}
                    {% if form.cloud_service_definition.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.cloud_service_definition.errors %} {{ error }} {% endfor %}
                        </div>
                    {% endif %}
                    {% if form.cloud_service_definition.help_text %}
                        <small class="form-text text-muted">{{ form.cloud_service_definition.help_text }}</small><br>
                    {% endif %}
                    <small class="form-text text-muted">If the service you need isn't listed, ask an Assessor or Admin to add it to the central list.</small>
                </div>
            {% else %}
                 <p class="alert alert-warning">Service selection field is missing from the form for creation.</p>
            {% endif %}
            {# NOTE: If "Add New Service" fields are needed on create, they must be added here manually #}
        {% endif %}

        {# --- Client-Editable Fields --- #}
        <div class="mb-3">
             <label for="{{ form.client_notes.id_for_label|default:'id_client_notes' }}" class="form-label">{{ form.client_notes.label|default:'Client Notes' }}{% if form.client_notes.field.required %}*{% endif %}</label>
            {% if is_client_user %}
                {# Assumes form for client contains client_notes #}
                {% if form.client_notes %}
                     {# Add form-control class via widget attrs in forms.py or manually if needed #}
                     {{ form.client_notes }}
                     {% if form.client_notes.errors %}
                         <div class="invalid-feedback d-block">
                             {% for error in form.client_notes.errors %} {{ error }} {% endfor %}
                         </div>
                     {% endif %}
                {% else %}
                    <p class="alert alert-warning">Client notes field missing from client form.</p>
                {% endif %}
            {% else %} {# Assessor/Admin read-only view #}
                 <div class="form-control-plaintext bg-light border rounded p-2" style="min-height: 70px;">
                     {% if object.client_notes %}{{ object.client_notes|linebreaksbr }}{% else %}<em class="text-muted">(None provided)</em>{% endif %}
                 </div>
            {% endif %}
             {% if form.client_notes.help_text %}<small class="form-text text-muted">{{ form.client_notes.help_text }}</small>{% endif %}
        </div>

        {# --- MFA Proof Section --- #}
        {% if is_client_user %}
             {# Client Editable Upload Fields - Assumes form contains these fields #}
             {% if form.mfa_admin_proof and form.mfa_user_proof %}
                 {# Admin MFA Proof #}
                 <div class="border p-3 mb-4 rounded bg-light">
                     <h6 class="mb-3">{{ form.mfa_admin_proof.label|default:"Admin MFA Proof" }}</h6>
                     <div class="row align-items-center">
                         <div class="col-md-7 mb-2 mb-md-0">
                             {# Add form-control class via widget attrs in forms.py #}
                             {{ form.mfa_admin_proof }} {# Renders file input and clear checkbox #}
                              {% if form.mfa_admin_proof.errors %}
                                 <div class="invalid-feedback d-block mt-1">
                                     {% for error in form.mfa_admin_proof.errors %} {{ error }} {% endfor %}
                                 </div>
                             {% endif %}
                             {% if form.mfa_admin_proof.help_text %}
                                <small class="form-text text-muted d-block mt-1">{{ form.mfa_admin_proof.help_text }}</small>
                            {% endif %}
                         </div>
                         <div class="col-md-5 text-center">
                             {% if object.mfa_admin_proof %}
                                 <p class="mb-1 small text-muted">Current Preview</p>
                                 <a href="{{ object.mfa_admin_proof.url }}" target="_blank" title="View current file">
                                     <img src="{{ object.mfa_admin_proof.url }}" alt="Admin MFA Proof Preview" class="img-thumbnail" style="max-height: 150px; object-fit: contain;">
                                 </a>
                             {% else %}
                                 <div class="text-center text-muted p-3 border rounded" style="height: 150px; display: flex; align-items: center; justify-content: center;">
                                     <small>No file uploaded</small>
                                 </div>
                             {% endif %}
                         </div>
                     </div>
                 </div>
                 {# User MFA Proof #}
                 <div class="border p-3 mb-4 rounded bg-light">
                     <h6 class="mb-3">{{ form.mfa_user_proof.label|default:"User MFA Proof" }}</h6>
                     <div class="row align-items-center">
                         <div class="col-md-7 mb-2 mb-md-0">
                            {# Add form-control class via widget attrs in forms.py #}
                            {{ form.mfa_user_proof }} {# Renders file input and clear checkbox #}
                             {% if form.mfa_user_proof.errors %}
                                 <div class="invalid-feedback d-block mt-1">
                                     {% for error in form.mfa_user_proof.errors %} {{ error }} {% endfor %}
                                 </div>
                             {% endif %}
                              {% if form.mfa_user_proof.help_text %}
                                <small class="form-text text-muted d-block mt-1">{{ form.mfa_user_proof.help_text }}</small>
                            {% endif %}
                         </div>
                         <div class="col-md-5 text-center">
                              {% if object.mfa_user_proof %}
                                 <p class="mb-1 small text-muted">Current Preview</p>
                                 <a href="{{ object.mfa_user_proof.url }}" target="_blank" title="View current file">
                                     <img src="{{ object.mfa_user_proof.url }}" alt="User MFA Proof Preview" class="img-thumbnail" style="max-height: 150px; object-fit: contain;">
                                 </a>
                             {% else %}
                                 <div class="text-center text-muted p-3 border rounded" style="height: 150px; display: flex; align-items: center; justify-content: center;">
                                     <small>No file uploaded</small>
                                 </div>
                             {% endif %}
                         </div>
                     </div>
                 </div>
            {% else %}
                 <p class="alert alert-warning">MFA proof fields missing from client form.</p>
            {% endif %}

        {% elif is_assessor_or_admin %}
             {# Assessor/Admin Read-only view of proof #}
             <div class="border p-3 mb-4 rounded">
                 <h6 class="mb-3">MFA Proof Submitted by Client</h6>
                 <div class="row">
                     <div class="col-md-6 mb-2 mb-md-0">
                         <p class="mb-1"><strong>Admin Proof:</strong></p>
                         {% if object.mfa_admin_proof %}
                             <a href="{{ object.mfa_admin_proof.url }}" target="_blank" class="btn btn-outline-primary btn-sm me-2">View File</a>
                             <img src="{{ object.mfa_admin_proof.url }}" alt="Admin Proof Preview" class="img-thumbnail align-middle" style="max-height: 75px; object-fit: contain;">
                         {% else %}
                             <em class="text-muted">None Submitted</em>
                         {% endif %}
                     </div>
                     <div class="col-md-6">
                          <p class="mb-1"><strong>User Proof:</strong></p>
                          {% if object.mfa_user_proof %}
                             <a href="{{ object.mfa_user_proof.url }}" target="_blank" class="btn btn-outline-primary btn-sm me-2">View File</a>
                             <img src="{{ object.mfa_user_proof.url }}" alt="User Proof Preview" class="img-thumbnail align-middle" style="max-height: 75px; object-fit: contain;">
                          {% else %}
                             <em class="text-muted">None Submitted</em>
                          {% endif %}
                     </div>
                 </div>
            </div>
        {% endif %}

        {# --- Assessor Verification Section --- #}
        {# Only show and make editable for Assessor/Admin during update #}
        {% if is_assessor_or_admin and object %}
            <div class="border p-3 mb-4 rounded bg-warning-subtle">
                <h5 class="mb-3">Assessor Verification</h5>
                {# Assumes form contains these fields #}

                 {% if form.mfa_admin_verified %}
                     <div class="form-check mb-2">
                         {# Add form-check-input class via widget attrs in forms.py #}
                         {{ form.mfa_admin_verified }}
                         <label class="form-check-label" for="{{ form.mfa_admin_verified.id_for_label }}">
                             {{ form.mfa_admin_verified.label }}
                         </label>
                         {% if form.mfa_admin_verified.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.mfa_admin_verified.errors %} {{ error }} {% endfor %}
                            </div>
                         {% endif %}
                    </div>
                 {% endif %}

                 {% if form.mfa_user_verified %}
                     <div class="form-check mb-2">
                         {{ form.mfa_user_verified }}
                         <label class="form-check-label" for="{{ form.mfa_user_verified.id_for_label }}">
                             {{ form.mfa_user_verified.label }}
                         </label>
                          {% if form.mfa_user_verified.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.mfa_user_verified.errors %} {{ error }} {% endfor %}
                            </div>
                         {% endif %}
                    </div>
                 {% endif %}

                 {% if form.is_compliant %}
                     <div class="form-check mb-3">
                        {{ form.is_compliant }}
                         <label class="form-check-label" for="{{ form.is_compliant.id_for_label }}">
                             {{ form.is_compliant.label }}
                         </label>
                          {% if form.is_compliant.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.is_compliant.errors %} {{ error }} {% endfor %}
                            </div>
                         {% endif %}
                    </div>
                 {% endif %}

                 {% if form.assessor_notes %}
                     <div class="mb-3">
                        <label for="{{ form.assessor_notes.id_for_label }}" class="form-label">{{ form.assessor_notes.label }}</label>
                        {# Add form-control class via widget attrs in forms.py #}
                        {{ form.assessor_notes }}
                        {% if form.assessor_notes.errors %}
                             <div class="invalid-feedback d-block">
                                {% for error in form.assessor_notes.errors %} {{ error }} {% endfor %}
                            </div>
                        {% endif %}
                        {% if form.assessor_notes.help_text %}
                            <small class="form-text text-muted">{{ form.assessor_notes.help_text }}</small>
                        {% endif %}
                    </div>
                {% endif %}

                {# Display verification info if available #}
                 {% if object.verified_by %}
                    <p class="small text-muted mt-3 mb-0">Last verified by {{ object.verified_by.username }} on {{ object.last_verified_at|date:"Y-m-d H:i" }}</p>
                 {% endif %}
            </div>
        {% endif %}
        {# --- END Assessor Verification Section --- #}

        <hr>
        <div class="mt-3">
            <button type="submit" class="btn btn-success">{% if object %}Save Changes{% else %}Add Service{% endif %}</button>
            {# Dynamic Cancel Link based on user role #}
            {% if user_role == 'Client' %}
                 <a href="{% url 'tracker:client_assessment_cloud_service_list' assessment.pk %}#cloud-services" class="btn btn-secondary">Cancel</a>
            {% else %} {# Assessor or Admin #}
                 <a href="{% url 'tracker:client_assessment_cloud_service_list' assessment.pk %}#cloud-services" class="btn btn-secondary">Cancel</a>
            {% endif %}
         </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
{# Removed the previous mismatched JavaScript block. #}
{# Add back JS only if needed, e.g., for the "Add New Service" toggle if that functionality is restored. #}
<script>
    // Add any necessary JavaScript here.
    // For example, if using crispy-forms with Bootstrap 5, file input styling might need adjustments.
    document.addEventListener('DOMContentLoaded', function() {
        // Potential fix for Bootstrap 5 styling of ClearableFileInput's checkbox
        document.querySelectorAll('.form-check input[type="checkbox"][name$="-clear"]').forEach(function(checkbox) {
            if (checkbox.parentElement.classList.contains('form-check')) {
                 // Already likely styled correctly by crispy-bootstrap5
             } else {
                 // Wrap checkbox and label if crispy didn't do it (might depend on crispy template pack)
                 const wrapper = document.createElement('div');
                wrapper.classList.add('form-check', 'mt-1'); // Add some margin
                 checkbox.classList.add('form-check-input');
                 const label = checkbox.nextElementSibling; // Assuming label is immediately after
                 if (label && label.tagName === 'LABEL') {
                    label.classList.add('form-check-label');
                    wrapper.appendChild(checkbox);
                    wrapper.appendChild(label);
                     label.parentNode.insertBefore(wrapper, label.nextSibling); // Insert wrapper
                 }
            }
        });
    });
</script>
{% endblock extra_js %}