{% extends "tracker/base.html" %}

{% block title %}Add Cloud Service Usage{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Add Cloud Service Usage to Assessment</h2>
    <p>Assessment: <a href="{% if user_role == 'Client' %}{% url 'tracker:client_assessment_detail' assessment.pk %}{% else %}{% url 'tracker:assessor_assessment_detail' assessment.pk %}{% endif %}"> </a></p>

    <form method="post" enctype="multipart/form-data" novalidate>
        {% csrf_token %}

        {# --- Non-Field Errors --- #}
        {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {% for error in form.non_field_errors %}
                    {{ error }}<br>
                {% endfor %}
            </div>
        {% endif %}

        {# --- Select Existing Service --- #}
        {% if form.cloud_service_definition %}
            <div class="mb-3">
                <label for="{{ form.cloud_service_definition.id_for_label }}" class="form-label">{{ form.cloud_service_definition.label }}{% if form.cloud_service_definition.field.required %}*{% endif %}</label>
                {# Add form-select class via widget attrs in forms.py if needed #}
                {{ form.cloud_service_definition }}
                {% if form.cloud_service_definition.errors %}
                    <div class="invalid-feedback d-block">
                        {% for error in form.cloud_service_definition.errors %} {{ error }} {% endfor %}
                    </div>
                {% endif %}
                {% if form.cloud_service_definition.help_text %}
                    <small class="form-text text-muted">{{ form.cloud_service_definition.help_text }}</small>
                {% endif %}
            </div>
        {% endif %}

        <hr>

        {# --- Suggest New Service --- #}
        {% if form.add_new_service %}
        <div class="mb-3">
             <div class="form-check">
                {# Add form-check-input class via widget attrs in forms.py #}
                {{ form.add_new_service }}
                 <label class="form-check-label" for="{{ form.add_new_service.id_for_label }}">
                    {{ form.add_new_service.label }}
                </label>
                 {% if form.add_new_service.errors %}
                    <div class="invalid-feedback d-block">
                        {% for error in form.add_new_service.errors %} {{ error }} {% endfor %}
                    </div>
                 {% endif %}
            </div>
            {% if form.add_new_service.help_text %}
                <small class="form-text text-muted">{{ form.add_new_service.help_text }}</small>
            {% endif %}
        </div>
        {% endif %}

        {# --- New Service Fields (Hidden initially) --- #}
        <div id="newServiceFields" class="{% if not form.add_new_service.value %}d-none{% endif %} border p-3 mb-3 bg-light rounded">
            <h5>New Service Details</h5>
             <p><small>Fill in these details if the service you need is not in the list above. It will be submitted for approval.</small></p>
            {% if form.new_service_name %}
            <div class="mb-3">
                <label for="{{ form.new_service_name.id_for_label }}" class="form-label">{{ form.new_service_name.label }}{% if form.new_service_name.field.required %}*{% endif %}</label>
                {{ form.new_service_name }} {# Add form-control class via widget attrs #}
                 {% if form.new_service_name.errors %}<div class="invalid-feedback d-block">{% for error in form.new_service_name.errors %} {{ error }} {% endfor %}</div>{% endif %}
                 {% if form.new_service_name.help_text %}<small class="form-text text-muted">{{ form.new_service_name.help_text }}</small>{% endif %}
            </div>
            {% endif %}
             {% if form.new_service_vendor %}
             <div class="mb-3">
                <label for="{{ form.new_service_vendor.id_for_label }}" class="form-label">{{ form.new_service_vendor.label }}{% if form.new_service_vendor.field.required %}*{% endif %}</label>
                {{ form.new_service_vendor }} {# Add form-control class via widget attrs #}
                 {% if form.new_service_vendor.errors %}<div class="invalid-feedback d-block">{% for error in form.new_service_vendor.errors %} {{ error }} {% endfor %}</div>{% endif %}
                 {% if form.new_service_vendor.help_text %}<small class="form-text text-muted">{{ form.new_service_vendor.help_text }}</small>{% endif %}
            </div>
            {% endif %}
             {% if form.new_service_url %}
             <div class="mb-3">
                 <label for="{{ form.new_service_url.id_for_label }}" class="form-label">{{ form.new_service_url.label }}{% if form.new_service_url.field.required %}*{% endif %}</label>
                {{ form.new_service_url }} {# Add form-control class via widget attrs #}
                 {% if form.new_service_url.errors %}<div class="invalid-feedback d-block">{% for error in form.new_service_url.errors %} {{ error }} {% endfor %}</div>{% endif %}
                 {% if form.new_service_url.help_text %}<small class="form-text text-muted">{{ form.new_service_url.help_text }}</small>{% endif %}
            </div>
            {% endif %}
             {% if form.new_service_description %}
             <div class="mb-3">
                 <label for="{{ form.new_service_description.id_for_label }}" class="form-label">{{ form.new_service_description.label }}{% if form.new_service_description.field.required %}*{% endif %}</label>
                {{ form.new_service_description }} {# Add form-control class via widget attrs #}
                 {% if form.new_service_description.errors %}<div class="invalid-feedback d-block">{% for error in form.new_service_description.errors %} {{ error }} {% endfor %}</div>{% endif %}
                 {% if form.new_service_description.help_text %}<small class="form-text text-muted">{{ form.new_service_description.help_text }}</small>{% endif %}
            </div>
             {% endif %}
             {% if form.new_service_requires_mfa %}
             <div class="mb-3">
                 <div class="form-check">
                    {{ form.new_service_requires_mfa }} {# Add form-check-input class via widget attrs #}
                     <label class="form-check-label" for="{{ form.new_service_requires_mfa.id_for_label }}">
                        {{ form.new_service_requires_mfa.label }}
                    </label>
                     {% if form.new_service_requires_mfa.errors %}<div class="invalid-feedback d-block">{% for error in form.new_service_requires_mfa.errors %} {{ error }} {% endfor %}</div>{% endif %}
                </div>
                {% if form.new_service_requires_mfa.help_text %}<small class="form-text text-muted">{{ form.new_service_requires_mfa.help_text }}</small>{% endif %}
            </div>
            {% endif %}
        </div>

        <hr>

        {# --- Client Notes --- #}
         {% if form.client_notes %}
         <div class="mb-3">
            <label for="{{ form.client_notes.id_for_label }}" class="form-label">{{ form.client_notes.label }}{% if form.client_notes.field.required %}*{% endif %}</label>
             {# Add form-control class via widget attrs #}
             {{ form.client_notes }}
             {% if form.client_notes.errors %}
                 <div class="invalid-feedback d-block">{% for error in form.client_notes.errors %} {{ error }} {% endfor %}</div>
             {% endif %}
             {% if form.client_notes.help_text %}<small class="form-text text-muted">{{ form.client_notes.help_text }}</small>{% endif %}
        </div>
        {% endif %}

        {# --- MFA Proof Uploads --- #}
        {% if form.mfa_admin_proof %}
        <div class="border p-3 mb-4 rounded bg-light">
            <h6 class="mb-3">{{ form.mfa_admin_proof.label }}</h6>
            {# Add form-control class via widget attrs #}
            {{ form.mfa_admin_proof }}
            {% if form.mfa_admin_proof.errors %}
                 <div class="invalid-feedback d-block mt-1">{% for error in form.mfa_admin_proof.errors %} {{ error }} {% endfor %}</div>
            {% endif %}
             {% if form.mfa_admin_proof.help_text %}<small class="form-text text-muted d-block mt-1">{{ form.mfa_admin_proof.help_text }}</small>{% endif %}
        </div>
        {% endif %}

        {% if form.mfa_user_proof %}
        <div class="border p-3 mb-4 rounded bg-light">
            <h6 class="mb-3">{{ form.mfa_user_proof.label }}</h6>
            {# Add form-control class via widget attrs #}
            {{ form.mfa_user_proof }}
            {% if form.mfa_user_proof.errors %}
                 <div class="invalid-feedback d-block mt-1">{% for error in form.mfa_user_proof.errors %} {{ error }} {% endfor %}</div>
            {% endif %}
             {% if form.mfa_user_proof.help_text %}<small class="form-text text-muted d-block mt-1">{{ form.mfa_user_proof.help_text }}</small>{% endif %}
        </div>
        {% endif %}

        {# --- Buttons --- #}
        <div class="mt-3">
            <button type="submit" class="btn btn-success">Add Service Usage</button>
            {# Use client-specific list URL for cancel on add form #}
            <a href="{% url 'tracker:client_assessment_cloud_service_list' assessment.pk %}" class="btn btn-secondary">Cancel</a>
         </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Ensure field IDs used here match the IDs rendered in your form
    const addNewCheckbox = document.getElementById('id_add_new_service'); // Default ID for add_new_service field
    const newServiceFieldsDiv = document.getElementById('newServiceFields');
    const existingServiceSelect = document.getElementById('id_cloud_service_definition'); // Default ID

    function toggleNewServiceFields() {
        if (addNewCheckbox && newServiceFieldsDiv) {
            if (addNewCheckbox.checked) {
                newServiceFieldsDiv.classList.remove('d-none');
                // Optionally disable/clear existing service select
                if (existingServiceSelect) {
                     // existingServiceSelect.disabled = true;
                     // existingServiceSelect.value = ''; // Clear selection if desired
                 }
                 // Optionally make new name required via JS (also handle in form clean)
                 // const newNameInput = document.getElementById('id_new_service_name');
                 // if (newNameInput) newNameInput.required = true;

            } else {
                newServiceFieldsDiv.classList.add('d-none');
                // Re-enable existing service select
                 if (existingServiceSelect) {
                     // existingServiceSelect.disabled = false;
                 }
                 // Optionally make new name not required via JS
                 // const newNameInput = document.getElementById('id_new_service_name');
                 // if (newNameInput) newNameInput.required = false;
            }
        }
    }

    if (addNewCheckbox) {
        addNewCheckbox.addEventListener('change', toggleNewServiceFields);
        // Set initial state on page load (in case of validation errors repopulating form)
        toggleNewServiceFields();
    }
});
</script>
{% endblock extra_js %}