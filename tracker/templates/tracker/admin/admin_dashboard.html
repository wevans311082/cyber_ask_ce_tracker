{% extends "tracker/base.html" %}
{% load i18n %}

{% block title %}{% trans "Admin Dashboard" %}{% endblock %}

{% block content %}
<h2>{% trans "Admin Dashboard" %}</h2>
<p>{% trans "Welcome" %}, {{ request.user.username }}!</p>

<div class="row">
    {# Main Content Column #}
    <div class="col-lg-8">

        {# System & Integration Health Card #}
       <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <i class="fas fa-shield-alt me-1"></i> {% trans "System & Integration Health" %}
            </div>
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-plug me-2 text-primary"></i>{% trans "Tenable.io API Status" %}:</span>
                        <span id="tenable-api-status-placeholder" class="badge bg-secondary">{% trans "Loading..." %}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-cogs me-2 text-primary"></i>{% trans "Background Task Health" %}:</span>
                        <span>
                            <span class="badge bg-light text-dark">
                                {{ celery_pending_tasks_count|default:0 }} {% trans "Pending" %}
                            </span>
                            {# Make failed tasks count clickable if there are failed tasks #}
                            {% if celery_failed_tasks_count > 0 %}
                                <button type="button" class="btn btn-link p-0 ms-2" data-bs-toggle="modal" data-bs-target="#failedTasksModal" id="viewFailedTasksBtn">
                                    <span class="badge bg-danger">
                                        {{ celery_failed_tasks_count }} {% trans "Failed" %} <i class="fas fa-eye ms-1"></i>
                                    </span>
                                </button>
                            {% else %}
                                <span class="badge bg-success ms-2">
                                    {{ celery_failed_tasks_count|default:0 }} {% trans "Failed" %}
                                </span>
                            {% endif %}
                        </span>
                    </li>
                    <li class="list-group-item">
                <i class="fas fa-exclamation-triangle me-2 text-danger"></i>{% trans "Last Critical System Error" %}:
                {% if latest_critical_error %}
                    <small class="text-muted" title="{{ latest_critical_error.timestamp|date:"Y-m-d H:i:s O" }}">
                        {{ latest_critical_error.timestamp|date:"Y-m-d H:i" }} {% trans "(UTC)" %} -
                    </small>
                    <span title="{{ latest_critical_error.message }}">
                        {{ latest_critical_error.message|truncatewords_html:10|striptags }}
                    </span>
                    <a href="{% url 'tracker:critical_error_detail' pk=latest_critical_error.pk %}" class="small ms-1">
                        (<i class="fas fa-search me-1"></i>{% trans "View Details & Acknowledge" %})
                    </a>
                {% else %}
                    <span class="text-success"><i class="fas fa-check-circle me-1"></i>{% trans "No unacknowledged critical errors." %}</span>
                {% endif %}
            </li>
                </ul>
            </div>
        </div>

        {# Assessment Pipeline Card #}
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <i class="fas fa-tasks me-1"></i> {% trans "Assessment Pipeline" %}
            </div>
            <div class="card-body">
                <div class="row text-center mb-3">
                    <div class="col">
                        <h5>{{ assessment_count|default:0 }}</h5>
                        <a href="{% url 'tracker:admin_assessment_list' %}" class="text-decoration-none">{% trans "Total Assessments" %}</a>
                    </div>
                    <div class="col">
                        <h5>{{ assessments_awaiting_scheduling_count|default:0 }}</h5>
                        <a href="{% url 'tracker:assessment_list_awaiting_scheduling' %}" class="text-decoration-none">{% trans "Awaiting Scheduling" %}</a>
                    </div>
                    <div class="col">
                        <h5>{{ assessments_with_scan_issues_count|default:0 }}</h5>
                        <a href="#" class="text-decoration-none">{% trans "With Scan Issues" %}</a> {# Placeholder URL: tracker:assessment_list_scan_issues_placeholder #}
                    </div>
                    <div class="col">
                        <h5>{{ recently_completed_assessments_count|default:0 }}</h5>
                        <a href="#" class="text-decoration-none">{% trans "Completed (30d)" %}</a> {# Placeholder URL: tracker:assessment_list_recently_completed_placeholder #}
                    </div>
                </div>
                {# Removed "Create New Assessment" button from here as it's in Quick Actions #}
            </div>
        </div>

        {# Data & Configuration Management Card (Collapsible) #}
        <div class="card mb-4">
            <div class="card-header" id="dataConfigHeader">
                <h5 class="mb-0">
                    <button class="btn btn-link text-dark text-decoration-none w-100 d-flex justify-content-between align-items-center" data-bs-toggle="collapse" data-bs-target="#collapseDataConfig" aria-expanded="true" aria-controls="collapseDataConfig">
                        <span><i class="fas fa-database me-1"></i> {% trans "Data & Configuration Management" %}</span>
                        <i class="fas fa-chevron-down collapse-icon"></i>
                    </button>
                </h5>
            </div>
            <div id="collapseDataConfig" class="collapse show" aria-labelledby="dataConfigHeader">
                <div class="card-body">
                    <h6><i class="fas fa-cogs me-2"></i>{% trans "System Configuration" %}</h6>
                    <div class="list-group list-group-flush mb-3">
                        <a href="{% url 'tracker:cloud_service_definition_list' %}" class="list-group-item list-group-item-action"><i class="fas fa-cloud me-2"></i>{% trans "Manage Cloud Service Definitions" %}</a>
                        <a href="{% url 'tracker:os_list' %}" class="list-group-item list-group-item-action"><i class="fas fa-desktop me-2"></i>{% trans "Manage Operating Systems" %}</a>
                    </div>

                    <h6><i class="fab fa-cloudscale me-2"></i>{% trans "Tenable Configuration" %}</h6>
                    <div class="list-group list-group-flush mb-3">
                        <a href="#" class="list-group-item list-group-item-action"><i class="fas fa-server me-2"></i>{% trans "Manage Tenable Scanners" %}</a> {# Placeholder URL: tracker:tenable_scanner_list_placeholder #}
                        <a href="#" class="list-group-item list-group-item-action"><i class="fas fa-shield-alt me-2"></i>{% trans "Manage Tenable Policies" %}</a> {# Placeholder URL: tracker:tenable_policy_list_placeholder #}
                    </div>

                    <h6><i class="fas fa-check-circle me-2"></i>{% trans "Data Integrity & Access" %}</h6>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <a href="{% url 'tracker:unlinked_report_list' %}" class="text-decoration-none"><i class="fas fa-unlink me-2"></i>{% trans "Unlinked CE Reports" %}</a>
                            <span class="badge bg-warning text-dark">{{ unlinked_ce_reports_count|default:0 }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <a href="#" class="text-decoration-none"><i class="fas fa-user-tag me-2"></i>{% trans "Clients Awaiting Tenable Config" %}</a> {# Placeholder URL: tracker:client_list_awaiting_tenable_config_placeholder #}
                            <span class="badge bg-warning text-dark">{{ clients_awaiting_tenable_config_count|default:0 }}</span>
                        </li>
                        <a href="{% url 'tracker:uploaded_report_list' %}" class="list-group-item list-group-item-action"><i class="fas fa-file-alt me-2"></i>{% trans "View All Uploaded Reports" %}</a>
                        <a href="#" class="list-group-item list-group-item-action"><i class="fas fa-users-cog me-2"></i>{% trans "View Tenable Agent Groups (Global)" %}</a> {# Placeholder URL: tracker:tenable_agent_group_list_placeholder #}
                        <a href="#" class="list-group-item list-group-item-action"><i class="fas fa-link me-2"></i>{% trans "View Agent to Scoped Item Mappings (Global)" %}</a> {# Placeholder URL: tracker:tenable_agent_mapping_list_placeholder #}
                    </ul>
                </div>
            </div>
        </div>

        {# User Management Insights Card #}
        <div class="card mb-4">
            <div class="card-header">
                <i class="fas fa-users me-1"></i> {% trans "User Management Insights" %}
            </div>
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <a href="{% url 'tracker:user_list' %}" class="text-decoration-none">{% trans "Total Users" %}</a>
                        <span class="badge bg-primary rounded-pill">{{ user_count|default:0 }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <a href="#" class="text-decoration-none">{% trans "Assessors Pending Availability Update" %}</a> {# Placeholder URL: tracker:assessor_availability_list_pending_placeholder #}
                        <span class="badge bg-info text-dark">{{ assessors_pending_availability_count|default:0 }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <a href="#" class="text-decoration-none">{% trans "Users with Incomplete MFA Setup" %}</a> {# Placeholder URL: tracker:user_list_incomplete_mfa_placeholder #}
                        <span class="badge bg-warning text-dark">{{ users_incomplete_mfa_count|default:0 }}</span>
                    </li>
                </ul>
                <a href="{% url 'tracker:user_create' %}" class="btn btn-outline-primary btn-sm mt-3 w-100"><i class="fas fa-user-plus me-1"></i>{% trans "Add New User" %}</a>
            </div>
        </div>

        {# Client Management Insights Card #}
        <div class="card mb-4">
            <div class="card-header">
                <i class="fas fa-briefcase me-1"></i> {% trans "Client Management Insights" %}
            </div>
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <a href="{% url 'tracker:client_list' %}" class="text-decoration-none">{% trans "Total Clients" %}</a>
                        <span class="badge bg-primary rounded-pill">{{ client_count|default:0 }}</span>
                    </li>
                    {# Add more client-specific KPIs here if needed #}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <a href="#" class="text-decoration-none"><i class="fas fa-user-tag me-2"></i>{% trans "Clients Awaiting Tenable Config" %}</a> {# Placeholder URL: tracker:client_list_awaiting_tenable_config_placeholder #}
                        <span class="badge bg-warning text-dark">{{ clients_awaiting_tenable_config_count|default:0 }}</span>
                    </li>
                </ul>
                 <a href="{% url 'tracker:client_create' %}" class="btn btn-outline-primary btn-sm mt-3 w-100"><i class="fas fa-building me-1"></i>{% trans "Add New Client" %}</a>
            </div>
        </div>
    </div>

    {# Sidebar Column #}
    <div class="col-lg-4">
        {# Service Approvals Card (Existing) #}
        <div class="card mb-4 {% if pending_approval_count > 0 %}border-warning{% endif %}">
            <div class="card-header"><i class="fas fa-bell me-1"></i>{% trans "Service Approvals" %}</div>
            <div class="card-body">
               {% if pending_approval_count > 0 %}
                    <p class="card-text text-warning">
                        <i class="fa-solid fa-triangle-exclamation me-1"></i>
                        {{ pending_approval_count }} {% blocktrans count counter=pending_approval_count %}service pending approval.{% plural %}services pending approval.{% endblocktrans %}
                    </p>
                    <a href="{% url 'tracker:cloud_service_definition_list' %}" class="btn btn-warning btn-sm mt-2">
                        <i class="fas fa-tasks me-1"></i> {% trans "Review Pending" %}
                    </a>
               {% else %}
                    <p class="card-text text-success">
                        <i class="fa-solid fa-check-circle me-1"></i>
                        {% trans "All suggested services approved." %}
                    </p>
               {% endif %}
           </div>
       </div>

       {# Quick Actions Card (Existing - some items moved) #}
       <div class="card mb-4">
           <div class="card-header"><i class="fas fa-bolt me-1"></i>{% trans "Quick Actions" %}</div>
           <div class="card-body">
               <a href="{% url 'tracker:assessment_create' %}" class="btn btn-success d-block mb-2"><i class="fas fa-plus-circle me-1"></i>{% trans "Create New Assessment" %}</a>
               <a href="{% url 'tracker:client_create' %}" class="btn btn-info d-block mb-2"><i class="fas fa-user-plus me-1"></i>{% trans "Add New Client" %}</a>
               <a href="{% url 'tracker:user_create' %}" class="btn btn-info d-block"><i class="fas fa-user-tie me-1"></i>{% trans "Add New User" %}</a>
           </div>
       </div>

       {# Administrative Utilities Card (New) #}
       <div class="card mb-4">
           <div class="card-header bg-secondary text-white">
               <i class="fas fa-tools me-1"></i> {% trans "Administrative Utilities" %}
           </div>
           <div class="card-body">
               <div class="list-group list-group-flush">
                   <a href="#" class="list-group-item list-group-item-action"><i class="fas fa-cog me-2"></i>{% trans "Global Application Settings" %}</a> {# Placeholder URL: tracker:global_settings_placeholder #}
                   <a href="#" class="list-group-item list-group-item-action"><i class="fas fa-history me-2"></i>{% trans "View System Audit Logs" %}</a> {# Placeholder URL: tracker:audit_log_viewer_placeholder #}
                   <a href="#" class="list-group-item list-group-item-action"><i class="fas fa-envelope-open-text me-2"></i>{% trans "Manage Notifications" %}</a> {# Placeholder URL: tracker:notification_management_placeholder #}
               </div>
           </div>
       </div>
    </div>
</div>


<div class="modal fade" id="failedTasksModal" tabindex="-1" aria-labelledby="failedTasksModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="failedTasksModalLabel">{% trans "Recent Failed Celery Tasks" %}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        {% if failed_celery_tasks_details %}
          <div class="table-responsive">
            <table class="table table-sm table-bordered">
              <thead>
                <tr>
                  <th>{% trans "Task ID" %}</th>
                  <th>{% trans "Task Name" %}</th>
                  <th>{% trans "Failed At" %}</th>
                  <th>{% trans "Arguments" %}</th>
                  <th>{% trans "Keyword Args" %}</th>
                  <th>{% trans "Traceback" %}</th>
                </tr>
              </thead>
              <tbody id="failedTasksTableBody">
                {% for task in failed_celery_tasks_details %}
                <tr>
                  <td><small>{{ task.task_id }}</small></td>
                  <td><small>{{ task.task_name }}</small></td>
                  <td><small>{{ task.date_done|date:"Y-m-d H:i:s" }}</small></td>
                  <td><pre class="bg-light p-1 small" style="max-height: 100px; overflow-y: auto;"><code>{{ task.args }}</code></pre></td>
                  <td><pre class="bg-light p-1 small" style="max-height: 100px; overflow-y: auto;"><code>{{ task.kwargs }}</code></pre></td>
                  <td><pre class="bg-light p-1 small" style="max-height: 200px; overflow-y: auto;"><code>{{ task.traceback }}</code></pre></td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p>{% trans "No failed tasks to display." %}</p>
        {% endif %}
      </div>
      <div class="modal-footer">
        {# Placeholder for future "Clear Failed Tasks" button #}
        {# <button type="button" class="btn btn-danger">Clear Failed Task Logs</button> #}
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Close" %}</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Tenable API Status (existing logic)
    const tenableStatusEl = document.getElementById('tenable-api-status-placeholder');
    const tenableApiStatus = "{{ tenable_api_status|default:'Not Available' }}";

    if (tenableStatusEl) { // Check if element exists
        tenableStatusEl.textContent = tenableApiStatus;
        if (tenableApiStatus === 'Connected') {
            tenableStatusEl.classList.remove('bg-secondary', 'bg-danger', 'text-dark');
            tenableStatusEl.classList.add('bg-success');
        } else if (tenableApiStatus === 'Connection Error' || tenableApiStatus === 'Not Available' || tenableApiStatus === 'Not Configured') {
            tenableStatusEl.classList.remove('bg-secondary', 'bg-success');
            tenableStatusEl.classList.add('bg-danger', 'text-white');
        } else {
            tenableStatusEl.classList.remove('bg-success', 'bg-danger');
            tenableStatusEl.classList.add('bg-secondary', 'text-dark');
        }
    }

    // Collapse icon rotation (existing logic)
    var dataConfigCollapse = document.getElementById('collapseDataConfig');
    if (dataConfigCollapse) {
        var collapseButton = document.querySelector('[data-bs-target="#collapseDataConfig"]');
        var collapseIcon = collapseButton.querySelector('.collapse-icon');

        dataConfigCollapse.addEventListener('show.bs.collapse', function () {
            collapseIcon.classList.remove('fa-chevron-down');
            collapseIcon.classList.add('fa-chevron-up');
        });
        dataConfigCollapse.addEventListener('hide.bs.collapse', function () {
            collapseIcon.classList.remove('fa-chevron-up');
            collapseIcon.classList.add('fa-chevron-down');
        });
        if (dataConfigCollapse.classList.contains('show')) {
            collapseIcon.classList.remove('fa-chevron-down');
            collapseIcon.classList.add('fa-chevron-up');
        }
    }

    // Failed Celery Tasks Modal Trigger (No dynamic JS population needed for this version)
    // The modal is populated by Django template tags directly.
    // The button with data-bs-toggle="modal" and data-bs-target="#failedTasksModal" handles showing it.
    // If you had a large number of tasks or wanted dynamic updates, you'd use JS to populate #failedTasksTableBody.
});
</script>
{% endblock %}