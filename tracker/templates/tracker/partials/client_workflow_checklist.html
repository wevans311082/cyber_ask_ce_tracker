{% load i18n %}
<div class="card mb-4" id="workflow-checklist-section">
  <div class="card-header">{% translate "Assessment Workflow Checklist" %}</div>
  <div class="card-body">
    {% if workflow_steps %}
      <div class="table-responsive">
        <table class="table table-sm table-hover align-middle">
          <thead>
            <tr>
              <th style="width:5%;">{% translate "Step" %}</th>
              <th style="width:40%;">{% translate "Requirement" %}</th>
              <th style="width:15%;">{% translate "Assigned To" %}</th>
              <th style="width:15%;">{% translate "Status" %}</th>
              <th style="width:25%;">{% translate "Actions / Notes" %}</th>
            </tr>
          </thead>
          <tbody>
            {% for step in workflow_steps %}
              <tr id="workflow-step-row-{{ step.pk }}"
                  class="{% if step == current_step and step.status != 'HelpNeeded' %}table-info{% elif step.status == 'HelpNeeded' %}table-warning{% endif %}">
                <td>{{ step.step_definition.step_order }}</td>
                <td>{{ step.step_definition.description|linebreaksbr }}</td>
                <td>{{ step.step_definition.get_assignee_type_display }}</td>
                <td id="workflow-status-{{ step.pk }}">
                  <span class="badge
                               {% if step.status == 'Complete' %}bg-success
                               {% elif step.status == 'InProgress' %}bg-info text-dark
                               {% elif step.status == 'HelpNeeded' %}bg-warning text-dark
                               {% elif step.status == 'Skipped' %}bg-secondary
                               {% else %}bg-light text-dark border{% endif %}">
                    {% if step.status == 'HelpNeeded' %}<i class="fa-solid fa-triangle-exclamation me-1"></i>{% endif %}
                    {{ step.get_status_display }}
                  </span>
                  {% if step.completed_by %}
                    <small class="d-block text-muted mt-1" id="workflow-completion-{{ step.pk }}">
                      {% translate "by" %} {{ step.completed_by.username }}
                      {% if step.completed_at %}{% translate "on" %} {{ step.completed_at|date:"Y-m-d" }}{% endif %}
                    </small>
                  {% else %}
                    <small class="d-block text-muted mt-1" id="workflow-completion-{{ step.pk }}"></small>
                  {% endif %}
                </td>
                <td id="workflow-actions-{{ step.pk }}">
                  {% if step.can_update %}
                    <div class="btn-group btn-group-sm workflow-action-group" role="group">
                      {% if step.status == 'NotStarted' %}
                        <button type="button" class="btn btn-outline-primary workflow-status-change-btn"
                                data-status="InProgress" data-step-pk="{{ step.pk }}" data-assessment-pk="{{ assessment.pk }}"
                                title="{% translate 'Mark as In Progress' %}">
                          <i class="fas fa-play"></i> {% translate "Start" %}
                        </button>
                      {% endif %}
                      {% if step.status in 'InProgress,HelpNeeded' %}
                        <button type="button" class="btn btn-outline-secondary workflow-status-change-btn"
                                data-status="NotStarted" data-step-pk="{{ step.pk }}" data-assessment-pk="{{ assessment.pk }}"
                                title="{% translate 'Reset to Not Started' %}">
                          <i class="fas fa-undo"></i> {% translate "Reset" %}
                        </button>
                      {% endif %}
                      {% if step.status != 'HelpNeeded' %}
                        <button type="button" class="btn btn-outline-warning workflow-status-change-btn"
                                data-status="HelpNeeded" data-step-pk="{{ step.pk }}" data-assessment-pk="{{ assessment.pk }}"
                                title="{% translate 'Mark as Help Needed' %}">
                          <i class="fas fa-question-circle"></i> {% translate "Help" %}
                        </button>
                      {% endif %}
                      {% if step.status != 'Complete' %}
                        <button type="button" class="btn btn-outline-success workflow-status-change-btn"
                                data-status="Complete" data-step-pk="{{ step.pk }}" data-assessment-pk="{{ assessment.pk }}"
                                title="{% translate 'Mark as Complete' %}">
                          <i class="fas fa-check"></i> {% translate "Done" %}
                        </button>
                      {% endif %}
                      {% if step.status == 'Complete' %}
                        <button type="button" class="btn btn-outline-secondary workflow-status-change-btn"
                                data-status="InProgress" data-step-pk="{{ step.pk }}" data-assessment-pk="{{ assessment.pk }}"
                                title="{% translate 'Reopen (Set In Progress)' %}">
                          <i class="fas fa-pencil-alt"></i> {% translate "Reopen" %}
                        </button>
                      {% endif %}
                    </div>
                    <div class="spinner-container mt-1" style="display:none;font-size:0.8em;">
                      <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                      {% translate "Updating..." %}
                    </div>
                    <div class="update-success-msg text-success small mt-1" style="display:none;">
                      <i class="fas fa-check-circle"></i> {% translate "Status Updated!" %}
                    </div>
                  {% elif step.status == 'Complete' %}
                    <span class="text-success"><i class="fa-solid fa-check-circle me-1"></i>{% translate "Completed" %}</span>
                  {% else %}
                    <span class="text-muted fst-italic small">{% translate "Pending" %} {{ step.step_definition.get_assignee_type_display }}</span>
                  {% endif %}

                  {% if step.notes %}
                    <p class="mt-2 mb-0"><small><strong>{% translate "Notes" %}:</strong> {{ step.notes|linebreaksbr }}</small></p>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="text-muted">{% translate "Workflow steps not yet generated for this assessment." %}</p>
    {% endif %}
  </div>
</div>
