{% load i18n static %}

<div class="card shadow-sm" id="assessment-info-card-{{ assessment.pk }}">
  <div class="card-header bg-light d-flex justify-content-between align-items-center">
    <h4 class="mb-0"><i class="fas fa-info-circle me-2"></i>{% translate "Assessment Information" %}</h4>
    <div>
      {% if not is_edit_mode and can_edit_assessment_info %}
        <button class="btn btn-outline-primary btn-sm py-1 px-2"
                hx-get="{% url 'tracker:load_named_card' assessment_pk=assessment.pk card_name='assessment_info' %}?edit_mode=true"
                hx-target="#assessment-info-card-{{ assessment.pk }}"
                hx-swap="outerHTML">
          <i class="fas fa-edit me-1"></i>{% translate "Edit" %}
        </button>
      {% endif %}
    </div>
  </div>
  <div class="card-body">
    {% if is_edit_mode and assessment_info_form %}
      {# --- Edit Mode --- #}
      <form method="post"
            hx-post="{% url 'tracker:save_assessment_info' assessment_pk=assessment.pk %}"
            hx-target="#assessment-info-card-{{ assessment.pk }}"
            hx-swap="outerHTML">
        {% csrf_token %}

        {# Loop through form fields for Bootstrap styling #}
        {% for field in assessment_info_form %}
          <div class="mb-3">
            <label for="{{ field.id_for_label }}" class="form-label">{{ field.label_tag }}</label>
            {{ field }}
            {% if field.help_text %}
              <small class="form-text text-muted">{{ field.help_text|safe }}</small>
            {% endif %}
            {% for error in field.errors %}
              <div class="invalid-feedback d-block">{{ error }}</div>
            {% endfor %}
          </div>
        {% endfor %}

        {% for error in assessment_info_form.non_field_errors %}
            <div class="alert alert-danger alert-sm p-2">{{ error }}</div>
        {% endfor %}

        <hr class="my-3">
        <div class="d-flex justify-content-end">
          <button type="button" class="btn btn-secondary btn-sm me-2"
                  hx-get="{% url 'tracker:load_named_card' assessment_pk=assessment.pk card_name='assessment_info' %}"
                  hx-target="#assessment-info-card-{{ assessment.pk }}"
                  hx-swap="outerHTML">
            {% translate "Cancel" %}
          </button>
          <button type="submit" class="btn btn-success btn-sm">
            <i class="fas fa-save me-1"></i>{% translate "Save Changes" %}
          </button>
        </div>
      </form>

    {% else %}
      {# --- View Mode (original content) --- #}
      <dl class="row">
        <dt class="col-sm-5">{% translate "Client" %}</dt><dd class="col-sm-7">{{ assessment.client.name }}</dd>
        <dt class="col-sm-5">{% translate "Assessor" %}</dt><dd class="col-sm-7">{{ assessment.assessor.username|default:_("Awaiting Assignment") }}</dd>
        <dt class="col-sm-5">{% translate "Status" %}</dt>
        <dd class="col-sm-7">
          <span class="badge
               {% if assessment.status == 'Pending' %}bg-warning text-dark
               {% elif assessment.status == 'InProgress' %}bg-info text-dark
               {% elif assessment.status == 'Scoping_Client' %}bg-info text-dark
               {% elif assessment.status == 'Scoping_Review' %}bg-secondary
               {% elif assessment.status == 'Complete' %}bg-success
               {% elif assessment.status == 'Cancelled' %}bg-danger
               {% else %}bg-primary{% endif %}">
            {{ assessment.get_status_display }}
          </span>
        </dd>
        <dt class="col-sm-5">{% translate "Scope Type" %}</dt><dd class="col-sm-7">{{ assessment.get_scope_type_display|default:"-" }}</dd>
        <dt class="col-sm-5">{% translate "Scope Desc." %}</dt><dd class="col-sm-7">{{ assessment.scope_description|default:"-"|linebreaksbr }}</dd>
        <dt class="col-sm-5">{% translate "CE Ref" %}</dt><dd class="col-sm-7">{{ assessment.ce_self_assessment_ref|default:"-" }}</dd>
        <dt class="col-sm-5">{% translate "Outcome" %}</dt>
        <dd class="col-sm-7">
          {% if assessment.final_outcome == 'Pass' %}<span class="badge bg-success">{{ assessment.get_final_outcome_display }}</span>
          {% elif assessment.final_outcome == 'Fail' %}<span class="badge bg-danger">{{ assessment.get_final_outcome_display }}</span>
          {% else %}<span class="text-muted">{% translate "Pending" %}</span>{% endif %}
        </dd>
      </dl>
      <h6 class="mt-4">{% translate "Key Dates" %}</h6>
      <dl class="row">
        <dt class="col-sm-5">{% translate "Scheduled" %}</dt><dd class="col-sm-7">{{ assessment.scheduled_date|date:"d M Y"|default:"-" }}</dd>
        <dt class="col-sm-5">{% translate "Target End" %}</dt><dd class="col-sm-7">{{ assessment.date_target_end|date:"Y-m-d"|default:"-" }}</dd>
        <dt class="col-sm-5">{% translate "Actual End" %}</dt><dd class="col-sm-7">{{ assessment.date_actual_end|date:"Y-m-d"|default:"-" }}</dd>
        <dt class="col-sm-5">{% translate "CE Passed" %}</dt><dd class="col-sm-7">{{ assessment.date_ce_passed|date:"Y-m-d"|default:"N/A" }}</dd>
        <dt class="col-sm-5">{% translate "Cert Issued" %}</dt><dd class="col-sm-7">{{ assessment.date_cert_issued|date:"Y-m-d"|default:"-" }}</dd>
        <dt class="col-sm-5">{% translate "Cert Expiry" %}</dt><dd class="col-sm-7">{{ assessment.date_cert_expiry|date:"Y-m-d"|default:"-" }}</dd>
      </dl>
      <hr class="my-4">
      <p class="mb-1"><strong>{% translate "Primary Contact" %}:</strong> {{ assessment.primary_contact_name|default:"-" }}</p>
      <p class="mb-1"><strong>{% translate "Primary Email" %}:</strong> {{ assessment.primary_contact_email|default:"-" }}</p>
      <p><strong>{% translate "Primary Phone" %}:</strong> {{ assessment.primary_contact_phone|default:"-" }}</p>
      <hr class="my-4">
      {% if assessment.report_file or assessment.uploaded_report %}<h6 class="mb-3">{% translate "Reports" %}</h6>{% endif %}
      {% if assessment.report_file %}
        <div class="mb-3"><a href="{{ assessment.report_file.url }}" class="btn btn-sm btn-outline-success w-100" target="_blank"><i class="fas fa-file-invoice me-2"></i>{% translate "Download Generated Report" %}</a></div>
      {% endif %}
      {% if assessment.uploaded_report %}
        <div class="mb-3">
          <a href="{{ assessment.uploaded_report.file.url }}" class="btn btn-sm btn-outline-info w-100" target="_blank">
            {% with file_type_lower=assessment.uploaded_report.file_type|lower %}
              {% if file_type_lower == 'pdf' %} <i class="fas fa-file-pdf text-danger me-2"></i>
              {% elif file_type_lower == 'doc' or file_type_lower == 'docx' %} <i class="fas fa-file-word text-primary me-2"></i>
              {% elif file_type_lower == 'xls' or file_type_lower == 'xlsx' %} <i class="fas fa-file-excel text-success me-2"></i>
              {% elif file_type_lower == 'ppt' or file_type_lower == 'pptx' %} <i class="fas fa-file-powerpoint text-warning me-2"></i>
              {% elif file_type_lower == 'zip' or file_type_lower == 'rar' %} <i class="fas fa-file-archive text-secondary me-2"></i>
              {% else %} <i class="fas fa-file-alt me-2"></i>{% endif %}
            {% endwith %}
            {% translate "Download Uploaded Report" %} {% if assessment.uploaded_report.file_type %}({{ assessment.uploaded_report.file_type }}){% endif %}
          </a>
          <p class="small text-muted text-center mt-1 mb-0">{% translate "Uploaded" %}: {{ assessment.uploaded_report.uploaded_at|date:"d M Y H:i" }}</p>
        </div>
      {% endif %}
      {% if assessment.report_file or assessment.uploaded_report %}<hr class="my-4">{% endif %}
      <button type="button" class="btn btn-outline-secondary w-100" data-bs-toggle="modal" data-bs-target="#logModal"><i class="fas fa-history me-2"></i>{% translate "View Assessment Log" %}</button>
    {% endif %} {# End is_edit_mode check #}
  </div>
</div>